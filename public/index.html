<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>In‚ÄëHouse Expensify ‚Äî New Expense</title>
    <link rel="stylesheet" href="/styles.css?v=3" />
    <script defer src="/app.js?v=3"></script>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <aside class="sidebar" aria-label="Primary">
      <div class="sidebar-brand">In‚ÄëHouse Expensify</div>
      <nav>
        <a href="/" aria-current="page">New Expense</a>
        <a href="/records">Records</a>
      </nav>
      <div class="sidebar-footer">
        <span id="user-pill" class="pill" title="Signed in"></span>
        <button id="theme-toggle" class="ghost small" aria-label="Toggle theme">üåô</button>
      </div>
    </aside>

    <header class="topbar">
      <button class="menu-toggle ghost" aria-label="Toggle menu">‚ò∞</button>
      <div class="topbar-title">New Expense</div>
      <div class="topbar-actions">
        <a class="ghost" href="/records">View Records</a>
      </div>
    </header>

    <main id="main" class="content">
      <section class="page-header">
        <h1>Submit an expense</h1>
        <p>Upload the receipt, review auto‚Äëfilled details, and submit.</p>
      </section>

      <section class="grid two">
        <form id="expense-form" class="panel" aria-labelledby="form-title">
          <h2 id="form-title">Receipt & Details</h2>
          <div class="field">
            <label for="image">Receipt image</label>
            <div id="dropzone" aria-label="Drop or click to upload">
              <span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px"><path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 16v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Drop image here or click to choose
              </span>
              <input id="image" name="image" type="file" accept="image/*" required />
            </div>
            <button type="button" id="analyze-btn">Analyze receipt</button>
          </div>

          <div class="field two-col">
            <div>
              <label for="name">Name</label>
              <input id="name" name="name" type="text" placeholder="e.g., Starbucks Team Lunch" />
            </div>
            <div>
              <label for="reimburse_to">Reimburse to</label>
              <input id="reimburse_to" name="reimburse_to" type="text" placeholder="None or a person" />
            </div>
          </div>

          <div class="field two-col">
            <div>
              <label for="amount">Amount</label>
              <input id="amount" name="amount" type="number" step="0.01" min="0" required />
            </div>
            <div>
              <label for="date">Date</label>
              <input id="date" name="date" type="date" />
            </div>
          </div>

          <div class="field">
            <label for="attendees">Who was attending?</label>
            <input id="attendees" name="attendees" type="text" placeholder="Comma-separated names" />
          </div>

          <div class="field">
            <label for="occasion">Occasion</label>
            <input id="occasion" name="occasion" type="text" placeholder="e.g., Team lunch" />
          </div>

          <div class="field">
            <label for="payment_method">How was it paid?</label>
            <select id="payment_method" name="payment_method">
              <option value="Company Card">Company Card</option>
              <option value="Personal Reimbursement">Personal Reimbursement</option>
              <option value="Cash">Cash</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <details class="more">
            <summary>More options</summary>
            <div class="field">
              <label for="category">Category</label>
              <select id="category" name="category">
                <option value="Travels">Travels</option>
                <option value="Meals">Meals</option>
                <option value="Supplies">Supplies</option>
                <option value="Others">Others</option>
              </select>
            </div>
            <div class="field two-col">
              <div>
                <label for="vat_rate">VAT Rate (Swiss%)</label>
                <select id="vat_rate" name="vat_rate">
                  <option value="">Unknown</option>
                  <option value="8.1">8.1</option>
                  <option value="2.6">2.6</option>
                  <option value="3.8">3.8</option>
                </select>
              </div>
              <div>
                <label for="currency">Currency</label>
                <select id="currency" name="currency">
                  <option value="">Unknown</option>
                  <option value="USD">USD</option>
                  <option value="CHF">CHF</option>
                  <option value="Euro">Euro</option>
                  <option value="CAD">CAD</option>
                </select>
              </div>
            </div>
          </details>

          <div class="actions">
            <button type="submit" class="primary">Submit Expense</button>
            <div id="status" role="status" aria-live="polite" class="muted"></div>
          </div>
        </form>

        <aside class="panel" aria-labelledby="preview-title">
          <h2 id="preview-title">Receipt preview</h2>
          <div class="preview-box">
            <img id="preview" hidden alt="Receipt preview" />
            <p class="muted" id="no-preview">No image selected yet.</p>
          </div>
          <ul class="hints">
            <li>Drag & drop an image above.</li>
            <li>Use ‚ÄúAnalyze receipt‚Äù to prefill fields.</li>
            <li>Review before submitting to Airtable.</li>
          </ul>
        </aside>
      </section>
    </main>

    <script>
      const form = document.getElementById('expense-form');
      const statusEl = document.getElementById('status');
      const analyzeBtn = document.getElementById('analyze-btn');
  const nameEl = document.getElementById('name');
  const reimburseEl = document.getElementById('reimburse_to');
      const amountEl = document.getElementById('amount');
      const dateEl = document.getElementById('date');
      const attendeesEl = document.getElementById('attendees');
      const occasionEl = document.getElementById('occasion');
      const paymentEl = document.getElementById('payment_method');
      const categoryEl = document.getElementById('category');
  const vatEl = document.getElementById('vat_rate');
  const currencyEl = document.getElementById('currency');

      function normalizeCategory(value) {
        if (!value) return '';
        const v = String(value).trim().toLowerCase();
        if (['travel','travels','trip','transport','transportation','flight','train','taxi','uber','lyft'].includes(v)) return 'Travels';
        if (['meal','meals','food','lunch','dinner','breakfast','restaurant'].includes(v)) return 'Meals';
        if (['supply','supplies','office supplies','stationery','hardware','equipment'].includes(v)) return 'Supplies';
        return 'Others';
      }

      // Default date to today if empty
      if (!dateEl.value) {
        const d = new Date();
        const m = String(d.getMonth()+1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        dateEl.value = `${d.getFullYear()}-${m}-${day}`;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = 'Uploading‚Ä¶';

        const fd = new FormData(form);
        try {
          const res = await fetch('/api/expenses', {
            method: 'POST',
            body: fd,
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Upload failed');
          statusEl.textContent = 'Saved! Record ID: ' + data.recordId;
          if (window.showToast) showToast('Expense saved', 'success');
          form.reset();
          const preview = document.getElementById('preview'); if (preview) preview.hidden = true;
          const noPrev = document.getElementById('no-preview'); if (noPrev) noPrev.hidden = false;
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        if (window.showToast) showToast(err.message, 'error');
      }
    });

      analyzeBtn.addEventListener('click', async () => {
        if (window.withBusy) {
          return withBusy(analyzeBtn, async () => {
            const file = document.getElementById('image').files[0];
            if (!file) {
              statusEl.textContent = 'Please choose an image first.';
              return;
            }
            statusEl.textContent = 'Analyzing receipt‚Ä¶';
            const fd = new FormData();
            fd.append('image', file);
            try {
              const res = await fetch('/api/analyze', { method: 'POST', body: fd });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Analyze failed');
              if (data.name) nameEl.value = data.name;
              if (data.amount != null) amountEl.value = data.amount;
              if (data.date) dateEl.value = data.date;
              if (data.attendees) attendeesEl.value = data.attendees;
              if (data.occasion) occasionEl.value = data.occasion;
              if (data.payment_method) paymentEl.value = data.payment_method;
              if (data.category) categoryEl.value = normalizeCategory(data.category);
              if (data.vat_rate != null) {
                const v = String(data.vat_rate);
                vatEl.value = ['8.1','2.6','3.8'].includes(v) ? v : '8.1';
              } else {
                vatEl.value = '8.1';
              }
              if (data.currency) currencyEl.value = data.currency;
              statusEl.textContent = 'Fields auto-filled. Please review and submit.';
              if (window.showToast) showToast('Fields auto-filled', 'success');
            } catch (err) {
              statusEl.textContent = 'Analyze error: ' + err.message;
              if (window.showToast) showToast('Analyze failed: ' + err.message, 'error');
            }
          });
        }
        const file = document.getElementById('image').files[0];
        if (!file) {
          statusEl.textContent = 'Please choose an image first.';
          return;
        }
        statusEl.textContent = 'Analyzing receipt‚Ä¶';
        const fd = new FormData();
        fd.append('image', file);
        try {
          const res = await fetch('/api/analyze', { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Analyze failed');
          if (data.name) nameEl.value = data.name;
          if (data.amount != null) amountEl.value = data.amount;
          if (data.date) dateEl.value = data.date;
          if (data.attendees) attendeesEl.value = data.attendees;
          if (data.occasion) occasionEl.value = data.occasion;
          if (data.payment_method) paymentEl.value = data.payment_method;
          if (data.category) categoryEl.value = normalizeCategory(data.category);
          if (data.vat_rate != null) {
            const v = String(data.vat_rate);
            vatEl.value = ['8.1','2.6','3.8'].includes(v) ? v : '8.1';
          } else {
            vatEl.value = '8.1';
          }
          if (data.currency) currencyEl.value = data.currency;
          statusEl.textContent = 'Fields auto-filled. Please review and submit.';
          if (window.showToast) showToast('Fields auto-filled', 'success');
        } catch (err) {
          statusEl.textContent = 'Analyze error: ' + err.message;
          if (window.showToast) showToast('Analyze failed: ' + err.message, 'error');
        }
      });
    </script>
  </body>
</html>
