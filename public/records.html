<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inâ€‘House Expensify â€” Records</title>
    <link rel="stylesheet" href="/styles.css?v=3" />
    <script defer src="/app.js?v=3"></script>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <aside class="sidebar" aria-label="Primary">
      <div class="sidebar-brand">Inâ€‘House Expensify</div>
      <nav>
        <a href="/">New Expense</a>
        <a href="/records" aria-current="page">Records</a>
      </nav>
      <div class="sidebar-footer">
        <span id="user-pill" class="pill" title="Signed in"></span>
        <button id="theme-toggle" class="ghost small" aria-label="Toggle theme">ðŸŒ™</button>
      </div>
    </aside>

    <header class="topbar">
      <button class="menu-toggle ghost" aria-label="Toggle menu">â˜°</button>
      <div class="topbar-title">Expense Records</div>
      <div class="topbar-actions">
        <a class="ghost" href="/">New Expense</a>
      </div>
    </header>

    <main id="main" class="content">
      <section class="page-header">
        <h1>Expenses by Month</h1>
        <p>Filter by month, review details, update statuses, and export a PDF.</p>
      </section>

      <section class="panel">
        <div class="toolbar">
          <div class="field">
            <label for="month">Month</label>
            <input id="month" type="month" />
          </div>
          <div class="toolbar-actions">
            <button id="load">Load</button>
            <div class="dropdown" id="export-dropdown">
              <button id="export-trigger">Export Report â–¾</button>
              <div class="dropdown-menu" id="export-menu" role="menu">
                <button type="button" data-option="raw-pdf">Raw PDF</button>
                <button type="button" data-option="raw-excel">Raw Excel</button>
                <button type="button" data-option="detailed-pdf">Detailed Overview PDF</button>
                <button type="button" data-option="email-raw-pdf">Send Raw PDF by Email</button>
                <button type="button" data-option="email-raw-excel">Send Raw Excel by Email</button>
                <button type="button" data-option="email-detailed-pdf">Send Detailed Overview PDF by Email</button>
              </div>
            </div>
          </div>
        </div>
        <div id="summary" class="muted"></div>
        <div id="export-status" class="muted small" style="margin-top:8px"></div>
      </section>

      <section class="panel">
        <div class="table-wrap">
          <table class="table" id="table" aria-label="Expenses table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Category</th>
                <th>Payment</th>
                <th>VAT</th>
                <th>Currency</th>
                <th>Status</th>
                <th>Receipt</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>
      </section>

    </main>

    <script>
      const monthEl = document.getElementById('month');
      const listEl = document.getElementById('list');
      const summaryEl = document.getElementById('summary');
      const loadBtn = document.getElementById('load');
      const exportDropdown = document.getElementById('export-dropdown');
      const exportTrigger = document.getElementById('export-trigger');
      const exportMenu = document.getElementById('export-menu');
      const exportStatus = document.getElementById('export-status');

      function currentMonth() {
        const d = new Date();
        const m = String(d.getMonth()+1).padStart(2, '0');
        return `${d.getFullYear()}-${m}`;
      }

      async function load(month) {
        listEl.innerHTML = '<tr><td colspan="9">Loadingâ€¦</td></tr>';
        summaryEl.textContent = '';
        try {
          const q = month ? `?month=${encodeURIComponent(month)}` : '';
          const res = await fetch(`/api/expenses${q}`);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Failed to load');

          const items = data.items || [];
          const totalCHF = items.reduce((s, it) => s + (Number(it.amount)||0), 0);
          summaryEl.textContent = `${data.month} â€” ${items.length} entries â€” CHF ${totalCHF.toFixed(2)}`;

          if (!items.length) { listEl.innerHTML = '<tr><td colspan="9">No records.</td></tr>'; return; }

          listEl.innerHTML = items.map(it => `
            <tr>
              <td>
                <div><strong>${it.name || '(no name)'}</strong></div>
                <div class=\"muted small\">${it.occasion || ''}${it.attendees ? ' â€¢ ' + it.attendees : ''}</div>
              </td>
              <td>CHF ${Number(it.amount||0).toFixed(2)}
                ${it.original_amount ? `<div class=\"muted small\">Orig: ${Number(it.original_amount).toFixed(2)} ${it.original_currency||''}</div>` : ''}
              </td>
              <td>${it.date || ''}</td>
              <td>${it.category || ''}</td>
              <td>${it.payment || ''}</td>
              <td>${it.vat_rate || 'â€”'}</td>
              <td><span class=\"muted small\">${it.currency || ''}</span></td>
              <td>
                <select data-record-id=\"${it.record_id}\" class=\"status-select\">
                  ${["Under Review","In-Progress","Done"].map(opt => `<option value=\"${opt}\" ${it.status===opt? 'selected':''}>${opt}</option>`).join('')}
                </select>
                <span class=\"small muted\" id=\"st-${it.record_id}\"></span>
                ${it.duplicate_hint ? `<div class=\"small\" style=\"color: var(--danger)\">Dup (${it.duplicate_count})</div>` : ''}
              </td>
              <td>${it.receipt_url ? `<a href=\"#\" onclick=\"openModalImage('${it.receipt_url.replace(/'/g, "\\'" )}');return false;\">View</a>` : ''}</td>
            </tr>
          `).join('');

          for (const sel of listEl.querySelectorAll('.status-select')) {
            sel.addEventListener('change', async () => {
              const rid = sel.getAttribute('data-record-id');
              const val = sel.value;
              const hint = document.getElementById(`st-${rid}`);
              hint.textContent = 'Savingâ€¦';
              try {
                const res = await fetch(`/api/expenses/${encodeURIComponent(rid)}/status`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ status: val })
                });
                const data = await res.json();
                if (!res.ok || data.ok === false) throw new Error(data.error || 'Failed');
                hint.textContent = 'Saved';
                if (window.showToast) showToast('Status updated', 'success');
                setTimeout(() => { hint.textContent = ''; }, 1500);
              } catch (err) {
                hint.textContent = 'Error: ' + err.message;
                if (window.showToast) showToast(err.message, 'error');
              }
            });
          }
        } catch (err) {
          listEl.innerHTML = `<tr><td colspan=\"9\">Error: ${err.message}</td></tr>`;
        }
      }

      if (loadBtn) {
        loadBtn.addEventListener('click', () => load(monthEl.value));
      }

      if (exportTrigger && exportDropdown && exportMenu) {
        const hideMenu = () => exportDropdown.classList.remove('open');
        exportTrigger.addEventListener('click', (ev) => {
          ev.stopPropagation();
          exportDropdown.classList.toggle('open');
        });
        document.addEventListener('click', (ev) => {
          if (!exportDropdown.contains(ev.target)) hideMenu();
        });
        document.addEventListener('keydown', (ev) => {
          if (ev.key === 'Escape') hideMenu();
        });
        exportMenu.querySelectorAll('button[data-option]').forEach((btn) => {
          btn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const option = btn.getAttribute('data-option');
            if (!option) return;
            hideMenu();
            const month = monthEl.value || currentMonth();
            if (option.startsWith('email-')) {
              if (exportStatus) exportStatus.textContent = 'Sendingâ€¦';
              try {
                const res = await fetch(`/api/export-report?month=${encodeURIComponent(month)}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ option })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.ok === false) throw new Error(data.error || 'Failed to send');
                if (exportStatus) exportStatus.textContent = `Email queued for ${data.month} (${data.variantLabel})`;
                if (window.showToast) showToast('Email queued', 'success');
              } catch (err) {
                if (exportStatus) exportStatus.textContent = 'Error: ' + err.message;
                if (window.showToast) showToast(err.message, 'error');
              }
            } else {
              const params = new URLSearchParams({ month, option, ts: Date.now().toString() });
              window.open(`/api/export-report?${params.toString()}`, '_blank');
              if (exportStatus) exportStatus.textContent = '';
            }
          });
        });
      }

      const cm = currentMonth();
      monthEl.value = cm;
      load(cm);
    </script>
  </body>
</html>
